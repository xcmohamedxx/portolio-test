<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portfolio Hub ‚Äî Browse & Create Portfolios</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#6ee7b7; --muted:#94a3b8; --glass:rgba(255,255,255,0.03);
    --glass-2:rgba(255,255,255,0.02);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#e6eef6;background:linear-gradient(180deg,#071028 0%, #071826 60%);}
  canvas#bg{position:fixed;inset:0;z-index:0}
  .app{position:relative;z-index:5;max-width:1200px;margin:28px auto;padding:28px;display:grid;gap:18px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#022;box-shadow:0 6px 20px rgba(2,6,23,0.6);overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:cover}
  h1{margin:0;font-size:1.25rem;letter-spacing:0.2px}
  .controls{display:flex;gap:8px;align-items:center}
  button, .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:var(--accent);padding:8px 12px;border-radius:8px;cursor:pointer;transition:all 0.2s}
  button:hover, .btn:hover{background:rgba(110,231,183,0.1);border-color:var(--accent)}
  .btn.secondary{background:transparent;color:#cfeefd;border:1px solid rgba(255,255,255,0.04)}
  .btn.primary{background:var(--accent);color:#022;font-weight:600}
  .hero{display:grid;grid-template-columns:1fr 420px;gap:18px;align-items:start}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  .intro h2{margin:0 0 8px 0;font-size:2rem}
  .muted{color:var(--muted);font-size:0.95rem}
  .ctas{margin-top:12px;display:flex;gap:8px;align-items:center}
  .card{padding:12px;border-radius:10px;background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:all 0.2s}
  .card:hover{border-color:var(--accent);background:linear-gradient(180deg,var(--card), rgba(110,231,183,0.05))}
  .card h3{margin:0 0 8px 0;font-size:1rem}
  footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted);font-size:0.9rem}
  
  .form-section{display:grid;gap:12px;margin:12px 0}
  .form-group{display:flex;flex-direction:column;gap:6px}
  .form-group label{font-size:0.9rem;color:var(--muted);font-weight:500}
  input[type="text"],input[type="email"],textarea,input[type="file"]{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.08);color:#cfeefd;padding:8px;border-radius:8px;font-family:inherit;font-size:0.95rem}
  input[type="text"]:focus,input[type="email"]:focus,textarea:focus,input[type="file"]:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,0.04)}
  textarea{resize:vertical;min-height:80px}
  
  .page{display:none}
  .page.active{display:block}
  
  .metric{display:flex;flex-direction:column;align-items:flex-start}
  .metric strong{font-size:1.1rem;color:var(--accent)}
  
  .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
  .portfolio-preview{padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:all 0.3s}
  .portfolio-preview:hover{border-color:var(--accent);transform:translateY(-4px);box-shadow:0 12px 30px rgba(110,231,183,0.15)}
  .portfolio-preview .preview-pic{width:100%;height:120px;border-radius:8px;background:var(--glass);margin-bottom:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .portfolio-preview .preview-pic img{width:100%;height:100%;object-fit:cover}
  .portfolio-preview h3{margin:0 0 4px 0;color:var(--accent);font-size:1.1rem}
  .portfolio-preview .email{font-size:0.85rem;color:var(--muted);margin:4px 0}
  .portfolio-preview .bio-text{font-size:0.9rem;color:#b4bfca;margin:8px 0;line-height:1.4}
  .portfolio-preview .skills{font-size:0.85rem;color:var(--muted);margin-top:8px}
  
  .profile-pic-section{display:flex;gap:12px;align-items:flex-start}
  .profile-pic-preview{width:120px;height:120px;border-radius:12px;background:var(--glass);display:flex;align-items:center;justify-content:center;overflow:hidden;border:2px solid rgba(110,231,183,0.3)}
  .profile-pic-preview img{width:100%;height:100%;object-fit:cover}
  
  .owner-only{display:none}
  .owner-only.show{display:flex}
  
  @media (max-width:980px){.hero{grid-template-columns:1fr;}}
  @media (max-width:620px){.brand h1{display:none}.hero{grid-template-columns:1fr;}.gallery-grid{grid-template-columns:1fr}}
  
  .verified-badge{display:inline-block;background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#000;padding:4px 10px;border-radius:20px;font-size:0.75rem;font-weight:600;margin-left:8px}
  .pinned-indicator{display:inline-block;color:#fbbf24;margin-left:8px;font-size:1.2rem}
  .portfolio-preview.pinned{border:2px solid #fbbf24;background:linear-gradient(180deg, rgba(251,191,36,0.1), rgba(251,191,36,0.02))}
  .portfolio-preview.pinned::before{content:'üìå Verified';position:absolute;top:12px;right:12px;background:#fbbf24;color:#000;padding:4px 8px;border-radius:6px;font-size:0.75rem;font-weight:600}
  
  .modal-backdrop{position:fixed;inset:0;background:rgba(1,6,16,0.8);display:none;align-items:center;justify-content:center;z-index:50;overflow:auto}
  .modal-backdrop.active{display:flex}
  .modal{width:min(500px,96vw);background:#041022;padding:24px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
  .modal h2{margin-top:0}
  .modal-content{margin:20px 0}
  .modal-actions{display:flex;gap:8px;margin-top:20px}
  
  .user-id-modal{position:fixed;inset:0;background:rgba(1,6,16,0.8);display:none;align-items:center;justify-content:center;z-index:60;overflow:auto}
  .user-id-modal.active{display:flex}
  .user-id-form{width:min(450px,96vw);background:#041022;padding:24px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
  .user-id-form h2{margin-top:0;color:var(--accent)}
  .user-id-display{background:rgba(110,231,183,0.1);padding:16px;border-radius:8px;border:2px solid var(--accent);margin:16px 0;text-align:center}
  .user-id-display .label{color:var(--muted);font-size:0.9rem;margin-bottom:8px}
  .user-id-display .id-value{font-family:monospace;font-size:1.2rem;color:var(--accent);font-weight:600;word-break:break-all}
  .user-id-actions{display:flex;gap:8px;margin-top:16px}
  
  .login-modal{position:fixed;inset:0;background:rgba(1,6,16,0.9);display:none;align-items:center;justify-content:center;z-index:70;overflow:auto}
  .login-modal.active{display:flex}
  .login-form{width:min(400px,96vw);background:#041022;padding:30px;border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
  .login-form h2{margin-top:0;color:var(--accent);font-size:1.5rem}
  .auth-tabs{display:flex;gap:0;margin-bottom:24px;border-bottom:1px solid rgba(255,255,255,0.1)}
  .auth-tab{flex:1;padding:12px;text-align:center;border-bottom:2px solid transparent;cursor:pointer;color:var(--muted);transition:all 0.2s}
  .auth-tab.active{border-bottom-color:var(--accent);color:var(--accent);font-weight:600}
  .auth-content{display:none}
  .auth-content.active{display:block}
  .user-badge{display:inline-block;background:rgba(110,231,183,0.1);border:1px solid var(--accent);padding:6px 12px;border-radius:20px;font-size:0.85rem;color:var(--accent)}
  
  .admin-badge{display:inline-block;background:linear-gradient(135deg,#f59e0b,#f97316);color:#000;padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:700;margin-left:8px}
  
  .admin-menu{display:none}
  .admin-menu.show{display:block}
  .admin-menu button{margin-left:8px;background:rgba(249,115,22,0.2);border-color:#f97316;color:#fbbf24}
  .admin-menu button:hover{background:rgba(249,115,22,0.3)}
  
  .admin-dashboard{position:fixed;inset:0;background:rgba(1,6,16,0.95);display:none;align-items:center;justify-content:center;z-index:80;overflow:auto}
  .admin-dashboard.active{display:flex}
  .admin-panel{width:min(900px,96vw);background:#041022;padding:30px;border-radius:12px;border:2px solid #f97316;max-height:90vh;overflow-y:auto}
  .admin-panel h2{margin-top:0;color:#f97316;font-size:1.8rem;border-bottom:2px solid #f97316;padding-bottom:12px}
  .admin-tabs{display:flex;gap:12px;margin:20px 0;flex-wrap:wrap}
  .admin-tab-btn{padding:10px 16px;border:2px solid rgba(249,115,22,0.3);background:transparent;color:#f97316;border-radius:8px;cursor:pointer;transition:all 0.2s;font-weight:600}
  .admin-tab-btn.active{background:#f97316;color:#000;border-color:#f97316}
  .admin-tab-btn:hover{border-color:#f97316}
  .admin-content{display:none;margin-top:20px}
  .admin-content.active{display:block}
  
  .security-stat{background:rgba(249,115,22,0.1);padding:16px;border-radius:8px;border-left:4px solid #f97316;margin:12px 0}
  .security-stat-label{color:var(--muted);font-size:0.9rem}
  .security-stat-value{font-size:1.8rem;color:#fbbf24;font-weight:700;margin-top:8px}
  
  .ip-item{background:var(--glass);padding:16px;border-radius:8px;margin:12px 0;border:1px solid rgba(255,255,255,0.1)}
  .ip-item.blocked{border-color:#ef4444;background:rgba(239,68,68,0.1)}
  .ip-item-header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .ip-item-status{display:inline-block;padding:4px 12px;border-radius:20px;font-size:0.8rem;font-weight:600}
  .ip-item-status.blocked{background:#ef4444;color:#fff}
  .ip-item-status.active{background:#10b981;color:#000}
  .alert-item{background:var(--glass);padding:12px;border-radius:8px;margin:8px 0;border-left:4px solid #fbbf24;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .alert-time{color:var(--muted);font-size:0.85rem;min-width:150px}
</style>
</head>
<body>
<canvas id="bg"></canvas>

<div class="app">
  <header>
    <div class="brand">
      <div class="logo" id="logo">PH</div>
      <div>
        <h1 id="siteName">Portfolio Hub</h1>
        <div class="muted" id="siteTagline">Browse portfolios or create your own</div>
      </div>
    </div>
    <div class="controls">
      <button id="backBtn" class="btn secondary" style="display:none">‚Üê Back</button>
      <span id="userStatus" class="user-badge" style="display:none"></span>
      <div class="admin-menu" id="adminMenu">
        <button id="adminDashboardBtn" class="btn">üîí Security</button>
      </div>
      <button id="logoutBtn" class="btn secondary" style="display:none;font-size:0.9rem">Logout</button>
      <button id="loginBtn" class="btn secondary" style="font-size:0.9rem">Login</button>
      <button id="makeOwnBtn" class="btn primary">Make Your Own</button>
    </div>
  </header>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="login-modal">
    <div class="login-form">
      <h2>Account</h2>
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
        <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
      </div>
      
      <!-- Login Tab -->
      <div id="loginTab" class="auth-content active">
        <div class="form-section">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="loginUsername" placeholder="Enter username">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" placeholder="Enter password">
          </div>
          <button id="loginSubmitBtn" class="btn primary" style="width:100%;margin-top:16px">Login</button>
          <button id="closeLoginModal" class="btn secondary" style="width:100%;margin-top:8px">Cancel</button>
        </div>
      </div>
      
      <!-- Register Tab -->
      <div id="registerTab" class="auth-content">
        <div class="form-section">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="registerUsername" placeholder="Choose username">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="registerPassword" placeholder="Create password">
          </div>
          <div class="form-group">
            <label>Confirm Password</label>
            <input type="password" id="registerPasswordConfirm" placeholder="Confirm password">
          </div>
          <button id="registerSubmitBtn" class="btn primary" style="width:100%;margin-top:16px">Register</button>
          <button id="closeRegisterModal" class="btn secondary" style="width:100%;margin-top:8px">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- VERIFICATION MODAL -->
  <div id="verificationModal" class="modal-backdrop">
    <div class="modal">
      <h2>Get Verified & Pinned</h2>
      <div class="modal-content">
        <p class="muted">Stand out from the crowd! Get your portfolio pinned to the top of the gallery and earn a verification badge.</p>
        <div style="background:var(--glass);padding:16px;border-radius:8px;margin:16px 0">
          <h3 style="margin-top:0">What you get:</h3>
          <ul style="margin:0;padding-left:20px;color:var(--muted)">
            <li>üìå Portfolio pinned at the top</li>
            <li>‚úì Verification badge on your profile</li>
            <li>‚≠ê Higher visibility to clients</li>
          </ul>
        </div>
        <div style="background:rgba(251,191,36,0.1);padding:16px;border-radius:8px;border:2px solid #fbbf24;margin:16px 0">
          <h3 style="margin-top:0;color:#fbbf24">$10 USD</h3>
          <p class="muted" style="margin:0">One-time payment via PayPal</p>
        </div>
        <div style="background:rgba(255,193,7,0.1);padding:16px;border-radius:8px;border:1px solid #fbbf24;margin:16px 0">
          <p style="margin:0;color:#ffd700;font-size:0.9rem"><strong>üìß After payment:</strong> Send payment proof to <strong>simohamedafif123@gmail.com</strong> and we'll verify your account within 24 hours.</p>
        </div>
      </div>
      <div class="modal-actions">
        <a id="paypalButton" href="https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&business=RZ8SQVZQRVVVN&item_name=Portfolio%20Verification&amount=10&currency_code=USD&return=" target="_blank" class="btn primary" style="flex:1;text-align:center;text-decoration:none;display:flex;align-items:center;justify-content:center">
          Pay with PayPal
        </a>
        <button id="closeVerificationModal" class="btn secondary">Close</button>
      </div>
    </div>
  </div>
  <!-- LOAD PORTFOLIO MODAL (replaced: removed auth/register logic) -->
  <div id="loadPortfolioModal" class="user-id-modal">
    <div class="user-id-form">
      <h2>Load Your Portfolio</h2>
      <p class="muted">Enter your Portfolio ID to access and edit your portfolio</p>
      <div class="form-group">
        <label>Portfolio ID</label>
        <input type="text" id="loadPortfolioIdInput" placeholder="Paste your Portfolio ID here">
      </div>
      <div class="user-id-actions">
        <button id="loadPortfolioBtn" class="btn primary" style="flex:1">Load Portfolio</button>
        <button id="closeLoadPortfolioModal" class="btn secondary" style="flex:1">Cancel</button>
      </div>
    </div>
  </div>

  <!-- USER ID MODAL -->
  <div id="userIdModal" class="user-id-modal">
    <div class="user-id-form">
      <h2 id="userIdTitle">Your Portfolio ID</h2>
      <p class="muted" id="userIdDescription">Save this ID to access your portfolio later</p>
      <div class="user-id-display">
        <div class="label">Your Portfolio ID</div>
        <div class="id-value" id="displayUserId">--</div>
      </div>
      <div class="user-id-actions">
        <button id="copyUserIdBtn" class="btn primary" style="flex:1">Copy ID</button>
        <button id="closeUserIdModal" class="btn secondary" style="flex:1">Done</button>
      </div>
    </div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard" class="admin-dashboard">
    <div class="admin-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2>üîí Admin Security Dashboard</h2>
        <button id="closeAdminDashboard" class="btn secondary">‚úï Close</button>
      </div>
      
      <div class="admin-tabs">
        <button class="admin-tab-btn active" onclick="switchAdminTab('overview')">Overview</button>
        <button class="admin-tab-btn" onclick="switchAdminTab('blocked-ips')">Blocked IPs</button>
        <button class="admin-tab-btn" onclick="switchAdminTab('alerts')">Alerts</button>
        <button class="admin-tab-btn" onclick="switchAdminTab('manage')">Manage</button>
      </div>

      <!-- Overview Tab -->
      <div id="overviewTab" class="admin-content active">
        <h3 style="color:var(--accent);margin-top:0">Security Overview</h3>
        <div id="securityStats"></div>
        <div style="margin-top:20px;padding:16px;background:rgba(34,197,94,0.1);border-radius:8px;border-left:4px solid #22c55e">
          <p style="margin:0;color:#86efac"><strong>‚úì System Status:</strong> All security systems active and monitoring</p>
        </div>
      </div>

      <!-- Blocked IPs Tab -->
      <div id="blockedIPsTab" class="admin-content">
        <h3 style="color:var(--accent);margin-top:0">Blocked IP Addresses</h3>
        <div id="blockedIPsList" style="max-height:400px;overflow-y:auto"></div>
      </div>

      <!-- Alerts Tab -->
      <div id="alertsTab" class="admin-content">
        <h3 style="color:var(--accent);margin-top:0">Recent Security Alerts</h3>
        <div id="alertsList" style="max-height:400px;overflow-y:auto"></div>
      </div>

      <!-- Manage Tab -->
      <div id="manageTab" class="admin-content">
        <h3 style="color:var(--accent);margin-top:0">Manage Security</h3>
        <div style="display:grid;gap:16px">
          <div style="background:var(--glass);padding:16px;border-radius:8px">
            <h4 style="margin-top:0;color:#fbbf24">Block IP Address</h4>
            <div style="display:flex;gap:8px;margin-top:12px">
              <input type="text" id="blockIPInput" placeholder="Enter IP address" style="flex:1">
              <button id="blockIPBtn" class="btn primary">Block</button>
            </div>
          </div>
          
          <div style="background:var(--glass);padding:16px;border-radius:8px">
            <h4 style="margin-top:0;color:#fbbf24">Unblock IP Address</h4>
            <div style="display:flex;gap:8px;margin-top:12px">
              <input type="text" id="unblockIPInput" placeholder="Enter IP address" style="flex:1">
              <button id="unblockIPBtn" class="btn primary">Unblock</button>
            </div>
          </div>

          <div style="background:var(--glass);padding:16px;border-radius:8px">
            <h4 style="margin-top:0;color:#fbbf24">Portfolio Management</h4>
            <p class="muted">As admin, you can edit any portfolio. View a portfolio and use the edit button.</p>
          </div>
        </div>
      </div>

      <button id="refreshSecurityBtn" class="btn primary" style="margin-top:20px;width:100%">üîÑ Refresh Data</button>
    </div>
  </div>
  <section class="page active" id="browsePage">
    <div style="margin-bottom:20px">
      <h2 style="margin:0 0 8px 0">Explore Portfolios</h2>
      <p class="muted">Click on any portfolio to view details</p>
    </div>
    <div class="gallery-grid" id="portfolioGallery"></div>
  </section>

  <!-- PAGE 2: VIEW SINGLE PORTFOLIO -->
  <section class="page" id="viewPortfolioPage">
    <!-- Header with title and controls -->
    <div style="margin-bottom:40px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:20px;flex-wrap:wrap">
        <div style="flex:1">
          <h1 id="viewPortfolioName" style="margin:0 0 8px 0;font-size:2.5rem">Portfolio Name</h1>
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
            <span id="verifiedBadge" class="verified-badge" style="display:none">‚úì Verified</span>
            <div class="muted" id="viewPortfolioEmail">email@example.com</div>
          </div>
          <div class="muted" style="font-size:0.95rem">
            <span>Created </span><strong id="viewPortfolioCreated" style="color:var(--accent)">--</strong>
          </div>
        </div>
        <!-- Controls: Edit, Delete, Verify, Unverify -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end" id="editControlsContainer" class="owner-only">
          <button id="editPortfolioBtn" class="btn">Edit</button>
          <button id="deletePortfolioBtn" class="btn secondary">Delete</button>
          <button id="verifyBtn" class="btn" style="display:none">Verify</button>
          <button id="unverifyBtn" class="btn secondary" style="display:none">Unverify</button>
        </div>
      </div>
    </div>

    <!-- Hero Section: Profile + Bio -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:50px;align-items:start">
      <div class="panel" style="padding:30px;text-align:center">
        <div class="profile-pic-preview" style="width:200px;height:200px;margin:0 auto 24px">
          <img id="viewProfilePic" src="" alt="Profile" style="display:none">
          <span id="viewProfilePicPlaceholder" style="font-size:5rem">üë§</span>
        </div>
        <button id="copyEmailBtn" class="btn primary" style="width:100%;margin-top:16px;cursor:pointer">üìã Copy Email</button>
        <button id="sharePortfolioBtn" class="btn" style="width:100%;margin-top:8px;cursor:pointer">üîó Share Portfolio</button>
        <button id="verifyPortfolioBtn" class="btn" style="width:100%;margin-top:8px;display:none">‚úì Get Verified</button>
      </div>

      <div class="panel" style="padding:30px">
        <h2 id="viewPortfolioBio" style="margin-top:0;margin-bottom:16px;font-size:1.8rem;line-height:1.4">Bio here</h2>
        <div style="margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid rgba(255,255,255,0.1)">
          <div class="muted" style="font-size:0.9rem;margin-bottom:8px">SKILLS</div>
          <div id="viewPortfolioSkills" style="display:flex;flex-wrap:wrap;gap:8px">
            <span class="badge" style="background:var(--glass);padding:6px 12px;border-radius:20px;font-size:0.9rem">Skills listed here</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Services Section -->
    <section style="margin-bottom:50px">
      <h2 style="margin:0 0 24px 0;font-size:1.8rem">Services</h2>
      <div id="viewServices" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">
        <div class="panel card" style="padding:24px;border:none"><div class="muted">No services</div></div>
      </div>
    </section>

    <!-- Portfolio Items Section -->
    <section>
      <h2 style="margin:0 0 24px 0;font-size:1.8rem">Portfolio</h2>
      <div id="viewPortfolios" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px">
        <div class="panel card" style="padding:24px;border:none"><div class="muted">No projects</div></div>
      </div>
    </section>
  </section>

  <!-- PAGE 3: CREATE/EDIT PORTFOLIO -->
  <section class="page" id="editPortfolioPage">
    <div class="panel" style="max-width:800px;margin:0 auto">
      <h2 style="margin-top:0" id="editModeTitle">Create Your Portfolio</h2>

      <div class="form-section">
        <div class="form-group">
          <label>Profile Picture</label>
          <div class="profile-pic-section">
            <div>
              <input type="file" id="profilePicInput" accept="image/*">
              <div class="profile-pic-preview" style="margin-top:8px">
                <img id="profilePicPreview" src="" alt="Profile" style="display:none">
                <span id="profilePicPlaceholder">üì∏</span>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="inputName" placeholder="Your Name">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="inputEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label>Bio / Headline</label>
          <textarea id="inputBio" placeholder="Describe yourself and what you do"></textarea>
        </div>
        <div class="form-group">
          <label>Skills (comma-separated)</label>
          <input type="text" id="inputSkills" placeholder="Python, JavaScript, Web Design">
        </div>
      </div>

      <h3 style="margin-top:20px">Services</h3>
      <div id="servicesForm" class="form-section"></div>
      <button id="addServiceBtn" class="btn" style="margin-bottom:20px">+ Add Service</button>

      <h3>Portfolio Items</h3>
      <div id="portfolioForm" class="form-section"></div>
      <button id="addPortfolioBtn" class="btn" style="margin-bottom:20px">+ Add Portfolio Item</button>

      <div style="display:flex;gap:8px;margin-top:20px">
        <button id="savePortfolioBtn" class="btn primary">Save Portfolio</button>
        <button id="cancelEditBtn" class="btn secondary">Cancel</button>
      </div>
    </div>
  </section>

  <footer>
    <div class="muted">Portfolio Hub ‚Äî Create & Share</div>
    <div class="muted" id="portfolioCount">0 portfolios</div>
  </footer>
</div>

<script>
/* ============ Background particles ============ */
const canvas = document.getElementById('bg');
const ctx = canvas.getContext('2d');
let W = canvas.width = innerWidth, H = canvas.height = innerHeight;
const pts = [];
const PT_COUNT = Math.round((W*H)/45000);
for(let i=0;i<PT_COUNT;i++) pts.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-0.5)*0.6,vy:(Math.random()-0.5)*0.6,r:1+Math.random()*2});
function resize(){ W = canvas.width = innerWidth; H = canvas.height = innerHeight; }
addEventListener('resize', resize);

let mouse = {x:W/2,y:H/2,active:false};
addEventListener('mousemove', e=>{mouse.x=e.clientX;mouse.y=e.clientY});
addEventListener('mousedown', ()=>mouse.active=true);
addEventListener('mouseup', ()=>mouse.active=false);

function step(){
  ctx.clearRect(0,0,W,H);
  for(let p of pts){
    p.x += p.vx; p.y += p.vy;
    if(p.x<0||p.x>W) p.vx*=-1;
    if(p.y<0||p.y>H) p.vy*=-1;
    const dx = p.x-mouse.x, dy = p.y-mouse.y;
    const d = Math.sqrt(dx*dx+dy*dy);
    if(mouse.active && d<120){ p.vx += dx/d*0.12; p.vy += dy/d*0.12; }
    ctx.beginPath();
    ctx.fillStyle = `rgba(110,231,183,${0.6 - Math.min(0.5, d/500)})`;
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  }
  for(let i=0;i<pts.length;i++){
    for(let j=i+1;j<pts.length;j++){
      const a=pts[i], b=pts[j], dx=a.x-b.x, dy=a.y-b.y, d2=dx*dx+dy*dy;
      if(d2<10000){
        ctx.strokeStyle = 'rgba(96,165,250,'+ (0.12 - d2/10000*0.08) +')';
        ctx.lineWidth = 0.8; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
      }
    }
  }
  requestAnimationFrame(step);
}
step();

/* ============ Data Management ============ */
let allPortfolios = JSON.parse(localStorage.getItem('allPortfolios')) || [];
let currentPortfolioId = null;
let currentUserId = localStorage.getItem('currentUserId') || null;
let currentUsername = localStorage.getItem('currentUsername') || null;
let isEditingExisting = false;
let tempProfilePic = null;
let users = JSON.parse(localStorage.getItem('users')) || {};

// Security tracking
let clientFingerprint = null;
let requestCount = 0;
let failedLoginAttempts = 0;
const MAX_LOCAL_FAILED_LOGINS = 3;

// Generate client fingerprint for additional tracking
function generateClientFingerprint() {
  const components = [
    navigator.userAgent,
    navigator.language,
    screen.width + 'x' + screen.height,
    new Date().getTimezoneOffset(),
    !!window.sessionStorage,
    !!window.localStorage
  ].join('|');
  
  return btoa(components).substring(0, 32);
}

// Initialize fingerprint on page load
window.addEventListener('load', () => {
  clientFingerprint = generateClientFingerprint();
  console.log('Client fingerprint:', clientFingerprint);
});

function saveAllPortfolios(){
  localStorage.setItem('allPortfolios', JSON.stringify(allPortfolios));
  updatePortfolioCount();
}

function saveUsers(){
  localStorage.setItem('users', JSON.stringify(users));
}

function saveCurrentUserId(userId, username){
  currentUserId = userId;
  currentUsername = username;
  localStorage.setItem('currentUserId', userId);
  localStorage.setItem('currentUsername', username);
  updateUserStatus();
  updateAdminStatus();
}

function logout(){
  currentUserId = null;
  currentUsername = null;
  localStorage.removeItem('currentUserId');
  localStorage.removeItem('currentUsername');
  updateUserStatus();
  updateAdminStatus();
  showPage('browsePage');
  renderGallery();
}

function updateUserStatus(){
  const userStatus = document.getElementById('userStatus');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginBtn = document.getElementById('loginBtn');
  
  if(currentUsername){
    const badge = isAdmin() ? '<span class="admin-badge">üëë ADMIN</span>' : '';
    userStatus.innerHTML = `üë§ ${currentUsername}${badge}`;
    userStatus.style.display = 'inline-block';
    logoutBtn.style.display = 'block';
    loginBtn.style.display = 'none';
  } else {
    userStatus.style.display = 'none';
    logoutBtn.style.display = 'none';
    loginBtn.style.display = 'block';
  }
}

function updatePortfolioCount(){
  const count = allPortfolios.length;
  document.getElementById('portfolioCount').textContent = count + ' portfolio' + (count !== 1 ? 's' : '');
}

function isOwner(portfolioId){
  const portfolio = allPortfolios.find(p => p.id === portfolioId);
  return portfolio && currentUsername && (portfolio.owner === currentUsername || isAdmin());
}

function setOwner(portfolioId, userId){
  localStorage.setItem('portfolioOwner_' + portfolioId, userId);
}

function isVerified(portfolioId){
  return localStorage.getItem('portfolioVerified_' + portfolioId) === 'true';
}

function setVerified(portfolioId){
  localStorage.setItem('portfolioVerified_' + portfolioId, 'true');
}

function getPinnedPortfolios(){
  return allPortfolios.filter(p => isVerified(p.id)).sort((a,b) => new Date(b.created) - new Date(a.created));
}

function getUnpinnedPortfolios(){
  return allPortfolios.filter(p => !isVerified(p.id)).sort((a,b) => new Date(b.created) - new Date(a.created));
}

/* ============ Page Navigation ============ */
function showPage(pageId){
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.getElementById('backBtn').style.display = pageId === 'browsePage' ? 'none' : 'block';
}

/* ============ Browse Page - Render Gallery ============ */
function renderGallery(){
  const gallery = document.getElementById('portfolioGallery');
  gallery.innerHTML = ''; // clear

  const pinned = getPinnedPortfolios();
  const unpinned = getUnpinnedPortfolios();
  const sorted = [...pinned, ...unpinned];

  if(sorted.length === 0){
    const empty = document.createElement('div');
    empty.className = 'card';
    empty.style.gridColumn = '1/-1';
    const h = document.createElement('h3'); h.textContent = 'No portfolios yet';
    const m = document.createElement('div'); m.className = 'muted'; m.textContent = 'Be the first to create one!';
    empty.appendChild(h); empty.appendChild(m);
    gallery.appendChild(empty);
    return;
  }

  for (const p of sorted){
    const card = document.createElement('div');
    card.className = 'portfolio-preview' + (isVerified(p.id) ? ' pinned' : '');
    card.setAttribute('role','button');
    card.tabIndex = 0;

    card.addEventListener('click', ()=> viewPortfolio(p.id));
    card.addEventListener('keydown', (e)=> {
      if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); viewPortfolio(p.id); }
    });

    const preview = document.createElement('div');
    preview.className = 'preview-pic';
    if(p.profilePic){
      const img = document.createElement('img');
      img.src = p.profilePic;
      img.alt = p.name || 'Profile';
      preview.appendChild(img);
    } else {
      preview.textContent = 'üë§';
    }
    card.appendChild(preview);

    const title = document.createElement('h3');
    title.textContent = p.name || 'Untitled';
    if(isVerified(p.id)){
      const ind = document.createElement('span');
      ind.className = 'pinned-indicator';
      ind.textContent = '‚úì';
      title.appendChild(ind);
    }
    card.appendChild(title);

    const emailDiv = document.createElement('div');
    emailDiv.className = 'email';
    emailDiv.textContent = p.email || '';
    card.appendChild(emailDiv);

    const bioDiv = document.createElement('div');
    bioDiv.className = 'bio-text';
    bioDiv.textContent = (p.bio || '').substring(0,80) + ((p.bio||'').length>80 ? '...' : '');
    card.appendChild(bioDiv);

    const skillsDiv = document.createElement('div');
    skillsDiv.className = 'skills';
    const strong = document.createElement('strong');
    strong.textContent = 'Skills:';
    skillsDiv.appendChild(strong);
    skillsDiv.appendChild(document.createTextNode(' ' + (p.skills || '')));
    card.appendChild(skillsDiv);

    gallery.appendChild(card);
  }
}

/* ============ View Portfolio Page ============ */
function viewPortfolio(portfolioId){
  const p = allPortfolios.find(x => x.id === portfolioId);
  if(!p) return;
  currentPortfolioId = portfolioId;
  isEditingExisting = false;
  const owner = isOwner(portfolioId);
  const verified = isVerified(portfolioId);

  document.getElementById('viewPortfolioName').textContent = p.name;
  const badge = document.getElementById('verifiedBadge');
  badge.style.display = verified ? 'inline-block' : 'none';

  document.getElementById('viewPortfolioEmail').textContent = p.email;
  document.getElementById('viewPortfolioBio').textContent = p.bio;
  
  const skillsArray = (p.skills || '').split(',').map(s => s.trim()).filter(s => s);
  const skillsHtml = skillsArray.length > 0 
    ? skillsArray.map(skill => `<span class="badge" style="background:var(--glass);padding:6px 12px;border-radius:20px;font-size:0.9rem">${skill}</span>`).join('')
    : '<span class="badge" style="background:var(--glass);padding:6px 12px;border-radius:20px;font-size:0.9rem;color:var(--muted)">No skills listed</span>';
  document.getElementById('viewPortfolioSkills').innerHTML = skillsHtml;
  
  document.getElementById('viewPortfolioCreated').textContent = new Date(p.created).toLocaleDateString();

  if(p.profilePic){
    document.getElementById('viewProfilePic').src = p.profilePic;
    document.getElementById('viewProfilePic').style.display = 'block';
    document.getElementById('viewProfilePicPlaceholder').style.display = 'none';
  } else {
    document.getElementById('viewProfilePic').style.display = 'none';
    document.getElementById('viewProfilePicPlaceholder').style.display = 'block';
  }

  const editControls = document.getElementById('editControlsContainer');
  editControls.classList.toggle('show', owner);

  const verifyBtn = document.getElementById('verifyPortfolioBtn');
  verifyBtn.style.display = (owner && !verified) ? 'block' : 'none';

  const servicesHtml = (p.services || []).length > 0
    ? (p.services || []).map(s => `
      <div class="panel" style="padding:24px">
        <h3 style="margin:0 0 12px 0;color:var(--accent);font-size:1.2rem">${s.title}</h3>
        <p style="margin:0;color:#b4bfca;line-height:1.6">${s.desc}</p>
      </div>
    `).join('')
    : '<div class="panel" style="padding:24px;text-align:center"><div class="muted">No services</div></div>';
  document.getElementById('viewServices').innerHTML = servicesHtml;

  const projectsHtml = (p.portfolio || []).length > 0
    ? (p.portfolio || []).map(proj => `
      <div class="panel" style="padding:24px;display:flex;flex-direction:column;gap:12px">
        <h3 style="margin:0 0 8px 0;color:var(--accent);font-size:1.2rem">${proj.title}</h3>
        <p style="margin:0;color:#b4bfca;line-height:1.6;flex:1">${proj.desc}</p>
        <a href="${proj.link}" target="_blank" rel="noopener noreferrer" class="btn primary" style="margin-top:12px;text-align:center;text-decoration:none;display:inline-block;width:100%">View Project ‚Üí</a>
      </div>
    `).join('')
    : '<div class="panel" style="padding:24px;text-align:center"><div class="muted">No projects</div></div>';
  document.getElementById('viewPortfolios').innerHTML = projectsHtml;

  // Update the portfolio view to show/hide buttons based on verification status
  function updatePortfolioView() {
    const isAdminUser = isAdmin();
    const isVerifiedPortfolio = isVerified(currentPortfolioId);

    // Admin controls (verify/unverify) live in the edit controls area
    const adminVerifyBtn = document.getElementById('verifyBtn');
    const adminUnverifyBtn = document.getElementById('unverifyBtn');
    if(adminVerifyBtn) adminVerifyBtn.style.display = (isAdminUser && !isVerifiedPortfolio) ? 'inline-block' : 'none';
    if(adminUnverifyBtn) adminUnverifyBtn.style.display = (isAdminUser && isVerifiedPortfolio) ? 'inline-block' : 'none';

    // Owner CTA for initiating verification flow (purchase)
    const ownerVerifyCTA = document.getElementById('verifyPortfolioBtn');
    if(ownerVerifyCTA) ownerVerifyCTA.style.display = (isOwner(currentPortfolioId) && !isVerifiedPortfolio) ? 'block' : 'none';
  }

  updatePortfolioView();
  showPage('viewPortfolioPage');
}

/* ============ Edit Mode ============ */
function renderEditMode(){
  const p = currentPortfolioId && isEditingExisting ? allPortfolios.find(x => x.id === currentPortfolioId) : null;
  
  document.getElementById('inputName').value = p?.name || '';
  document.getElementById('inputEmail').value = p?.email || '';
  document.getElementById('inputBio').value = p?.bio || '';
  document.getElementById('inputSkills').value = p?.skills || '';
  
  if(p?.profilePic){
    document.getElementById('profilePicPreview').src = p.profilePic;
    document.getElementById('profilePicPreview').style.display = 'block';
    document.getElementById('profilePicPlaceholder').style.display = 'none';
  } else {
    document.getElementById('profilePicPreview').style.display = 'none';
    document.getElementById('profilePicPlaceholder').style.display = 'block';
  }

  const services = p?.services || [];
  const servicesForm = document.getElementById('servicesForm');
  servicesForm.innerHTML = services.map((s, i) => `
    <div class="form-group" style="background:var(--glass);padding:12px;border-radius:8px">
      <label>Service Title</label>
      <input type="text" data-service-title="${i}" value="${s.title}">
      <label>Description</label>
      <textarea data-service-desc="${i}">${s.desc}</textarea>
      <button type="button" class="btn" onclick="removeService(${i})" style="max-width:120px">Remove</button>
    </div>
  `).join('');

  const projects = p?.portfolio || [];
  const portfolioForm = document.getElementById('portfolioForm');
  portfolioForm.innerHTML = projects.map((proj, i) => `
    <div class="form-group" style="background:var(--glass);padding:12px;border-radius:8px">
      <label>Project Title</label>
      <input type="text" data-portfolio-title="${i}" value="${proj.title}">
      <label>Description</label>
      <textarea data-portfolio-desc="${i}">${proj.desc}</textarea>
      <label>Link</label>
      <input type="text" data-portfolio-link="${i}" value="${proj.link}">
      <button type="button" class="btn" onclick="removePortfolio(${i})" style="max-width:120px">Remove</button>
    </div>
  `).join('');
}

function removeService(i){ 
  const servicesForm = document.getElementById('servicesForm');
  const inputs = servicesForm.querySelectorAll('[data-service-title]');
  if(i < inputs.length) inputs[i].parentElement.remove();
}

function removePortfolio(i){ 
  const portfolioForm = document.getElementById('portfolioForm');
  const inputs = portfolioForm.querySelectorAll('[data-portfolio-title]');
  if(i < inputs.length) inputs[i].parentElement.remove();
}

function addService(){
  const servicesForm = document.getElementById('servicesForm');
  const count = servicesForm.querySelectorAll('[data-service-title]').length;
  const html = `
    <div class="form-group" style="background:var(--glass);padding:12px;border-radius:8px">
      <label>Service Title</label>
      <input type="text" data-service-title="${count}" value="New Service">
      <label>Description</label>
      <textarea data-service-desc="${count}">Describe your service</textarea>
      <button type="button" class="btn" onclick="removeService(${count})" style="max-width:120px">Remove</button>
    </div>
  `;
  servicesForm.insertAdjacentHTML('beforeend', html);
}

function addPortfolio(){
  const portfolioForm = document.getElementById('portfolioForm');
  const count = portfolioForm.querySelectorAll('[data-portfolio-title]').length;
  const html = `
    <div class="form-group" style="background:var(--glass);padding:12px;border-radius:8px">
      <label>Project Title</label>
      <input type="text" data-portfolio-title="${count}" value="New Project">
      <label>Description</label>
      <textarea data-portfolio-desc="${count}">Describe your project</textarea>
      <label>Link</label>
      <input type="text" data-portfolio-link="${count}" value="https://example.com">
      <button type="button" class="btn" onclick="removePortfolio(${count})" style="max-width:120px">Remove</button>
    </div>
  `;
  portfolioForm.insertAdjacentHTML('beforeend', html);
}

/* ============ Authentication ============ */
function switchAuthTab(tab){
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.auth-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tab + 'Tab').classList.add('active');
}

// Validate username format (prevent injection)
function validateUsername(username) {
  const pattern = /^[a-zA-Z0-9_-]{3,20}$/;
  return pattern.test(username);
}

// Validate email format
function validateEmail(email) {
  const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return pattern.test(email);
}

// Sanitize string input to prevent XSS
function sanitizeInput(input) {
  const div = document.createElement('div');
  div.textContent = input;
  return div.innerHTML;
}

// Check password strength
function checkPasswordStrength(password) {
  let strength = 0;
  if (password.length >= 8) strength += 1;
  if (password.match(/[a-z]/)) strength += 1;
  if (password.match(/[A-Z]/)) strength += 1;
  if (password.match(/[0-9]/)) strength += 1;
  if (password.match(/[^a-zA-Z0-9]/)) strength += 1;
  return strength;
}

function registerAccount(){
  const username = document.getElementById('registerUsername').value.trim();
  const password = document.getElementById('registerPassword').value;
  const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
  
  // Validation
  if(!username || !password){ alert('Enter username and password'); return; }
  
  if(!validateUsername(username)) {
    alert('Username must be 3-20 characters (letters, numbers, dash, underscore only)');
    return;
  }
  
  if(password !== passwordConfirm){ alert('Passwords do not match'); return; }
  if(password.length < 6){ alert('Password must be at least 6 characters'); return; }
  
  const strength = checkPasswordStrength(password);
  if(strength < 2) {
    alert('Password too weak. Use mix of uppercase, lowercase, numbers, and symbols');
    return;
  }
  
  if(users[username]){ alert('Username already taken'); return; }
  
  // Sanitize before storing
  const sanitizedUsername = sanitizeInput(username);
  
  users[sanitizedUsername] = {
    password: btoa(password), // Simple encoding (in production use bcrypt)
    id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    createdAt: new Date().toISOString(),
    fingerprint: clientFingerprint
  };
  saveUsers();
  saveCurrentUserId(users[sanitizedUsername].id, sanitizedUsername);
  document.getElementById('loginModal').classList.remove('active');
  alert('‚úì Account created! Welcome ' + sanitizedUsername + '!');
  
  // Reset failed login counter
  failedLoginAttempts = 0;
}

function loginAccount(){
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  if(!username || !password){ alert('Enter username and password'); return; }
  
  // Rate limit login attempts
  failedLoginAttempts++;
  if(failedLoginAttempts > MAX_LOCAL_FAILED_LOGINS) {
    alert('‚ö†Ô∏è Too many failed login attempts. Please wait before trying again.');
    return;
  }
  
  // Sanitize input
  const sanitizedUsername = sanitizeInput(username);
  
  const user = users[sanitizedUsername];
  if(!user){ 
    alert('‚ùå Account not found');
    return; 
  }
  
  const storedPassword = atob(user.password); // Decode (for comparison)
  if(storedPassword !== password){ 
    alert('‚ùå Wrong password');
    return;
  }
  
  // Successful login - reset counter
  failedLoginAttempts = 0;
  
  saveCurrentUserId(user.id, sanitizedUsername);
  document.getElementById('loginModal').classList.remove('active');
  alert('‚úì Welcome back, ' + sanitizedUsername + '!');
}

function generateShareLink(portfolioId){
  return window.location.origin + window.location.pathname + '?view=' + portfolioId;
}

function getPortfolioByUsername(username){
  return allPortfolios.find(p => p.owner === username);
}

/* ============ Event Listeners ============ */
document.getElementById('loginBtn')?.addEventListener('click', ()=>{
  document.getElementById('loginModal').classList.add('active');
  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';
});

document.getElementById('closeLoginModal')?.addEventListener('click', ()=>{
  document.getElementById('loginModal').classList.remove('active');
});

document.getElementById('closeRegisterModal')?.addEventListener('click', ()=>{
  document.getElementById('loginModal').classList.remove('active');
});

document.getElementById('loginSubmitBtn')?.addEventListener('click', loginAccount);
document.getElementById('registerSubmitBtn')?.addEventListener('click', registerAccount);

document.getElementById('logoutBtn')?.addEventListener('click', ()=>{
  if(confirm('Logout?')){
    logout();
    alert('Logged out');
  }
});

document.getElementById('sharePortfolioBtn')?.addEventListener('click', ()=>{
  const shareLink = generateShareLink(currentPortfolioId);
  document.getElementById('displayUserId').textContent = shareLink;
  document.getElementById('userIdTitle').textContent = 'Share Your Portfolio';
  document.getElementById('userIdDescription').textContent = 'Share this link with others to view your portfolio';
  document.getElementById('userIdModal').classList.add('active');
});

window.addEventListener('load', ()=>{
  const params = new URLSearchParams(window.location.search);
  const viewId = params.get('view');
  if(viewId){
    const portfolio = allPortfolios.find(p => p.id === viewId);
    if(portfolio){
      viewPortfolio(viewId);
    }
  }
  updateUserStatus();
});

document.getElementById('profilePicInput').addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = (evt)=>{
      tempProfilePic = evt.target.result;
      document.getElementById('profilePicPreview').src = tempProfilePic;
      document.getElementById('profilePicPreview').style.display = 'block';
      document.getElementById('profilePicPlaceholder').style.display = 'none';
    };
    reader.readAsDataURL(file);
  }
});

document.getElementById('makeOwnBtn').addEventListener('click', ()=>{
  currentPortfolioId = null;
  isEditingExisting = false;
  tempProfilePic = null;
  document.getElementById('editModeTitle').textContent = 'Create Your Portfolio';
  document.getElementById('inputName').value = '';
  document.getElementById('inputEmail').value = '';
  document.getElementById('inputBio').value = '';
  document.getElementById('inputSkills').value = '';
  document.getElementById('profilePicInput').value = '';
  document.getElementById('profilePicPreview').style.display = 'none';
  document.getElementById('profilePicPlaceholder').style.display = 'block';
  document.getElementById('servicesForm').innerHTML = '';
  document.getElementById('portfolioForm').innerHTML = '';
  showPage('editPortfolioPage');
});

document.getElementById('backBtn').addEventListener('click', ()=>{
  showPage('browsePage');
});

document.getElementById('editPortfolioBtn').addEventListener('click', ()=>{
  if(!currentUsername){ alert('Please login to edit portfolios'); return; }
  if(!isOwner(currentPortfolioId)){ alert('You can only edit your own portfolio'); return; }
  isEditingExisting = true;
  document.getElementById('editModeTitle').textContent = 'Edit Your Portfolio';
  renderEditMode();
  showPage('editPortfolioPage');
});

document.getElementById('deletePortfolioBtn').addEventListener('click', ()=>{
  if(!currentUsername){ alert('Please login to delete portfolios'); return; }
  if(!isOwner(currentPortfolioId)){ alert('You can only delete your own portfolio'); return; }
  if(confirm('Delete this portfolio?')){
    allPortfolios = allPortfolios.filter(p => p.id !== currentPortfolioId);
    saveAllPortfolios();
    showPage('browsePage');
    renderGallery();
  }
});

document.getElementById('savePortfolioBtn').addEventListener('click', ()=>{
  const name = sanitizeInput(document.getElementById('inputName').value || 'Portfolio');
  const email = document.getElementById('inputEmail').value || 'noemail@example.com';
  const bio = sanitizeInput(document.getElementById('inputBio').value || 'No bio');
  const skills = sanitizeInput(document.getElementById('inputSkills').value || 'No skills');
  
  // Validate email
  if(!validateEmail(email)) {
    alert('‚ùå Please enter a valid email address');
    return;
  }
  
  // Validate name
  if(name.length < 2) {
    alert('‚ùå Name must be at least 2 characters');
    return;
  }
  
  const profilePic = tempProfilePic || (currentPortfolioId && isEditingExisting ? allPortfolios.find(x => x.id === currentPortfolioId)?.profilePic : null);

  const services = [];
  document.querySelectorAll('[data-service-title]').forEach((el, i)=>{
    const descEl = document.querySelector(`[data-service-desc="${i}"]`);
    if(descEl) {
      services.push({
        title: sanitizeInput(el.value || 'Service'), 
        desc: sanitizeInput(descEl.value || 'Description')
      });
    }
  });

  const portfolio = [];
  document.querySelectorAll('[data-portfolio-title]').forEach((el, i)=>{
    const descEl = document.querySelector(`[data-portfolio-desc="${i}"]`);
    const linkEl = document.querySelector(`[data-portfolio-link="${i}"]`);
    if(descEl && linkEl){
      // Validate URL
      const link = linkEl.value;
      if(!link.startsWith('http://') && !link.startsWith('https://')) {
        console.warn('Invalid URL:', link);
        linkEl.value = 'https://' + link;
      }
      
      portfolio.push({
        title: sanitizeInput(el.value || 'Project'),
        desc: sanitizeInput(descEl.value || 'Description'),
        link: linkEl.value.substring(0, 2048) // URL length limit
      });
    }
  });

  if(isEditingExisting){
    const existing = allPortfolios.find(x => x.id === currentPortfolioId);
    if(existing){
      existing.name = name;
      existing.email = email;
      existing.bio = bio;
      existing.skills = skills;
      existing.profilePic = profilePic;
      existing.services = services;
      existing.portfolio = portfolio;
      existing.lastModified = new Date().toISOString();
    }
  } else {
    if(!currentUsername){ alert('‚ùå Please login first'); return; }
    const newId = Date.now().toString();
    allPortfolios.push({
      id: newId,
      owner: currentUsername,
      name,
      email,
      bio,
      skills,
      profilePic,
      services,
      portfolio,
      created: new Date().toISOString(),
      lastModified: new Date().toISOString(),
      fingerprint: clientFingerprint
    });
    
    const shareLink = generateShareLink(newId);
    document.getElementById('displayUserId').textContent = shareLink;
    document.getElementById('userIdTitle').textContent = 'Your Portfolio Link';
    document.getElementById('userIdDescription').textContent = 'Share this link so others can view your portfolio';
    document.getElementById('userIdModal').classList.add('active');
  }

  saveAllPortfolios();
  tempProfilePic = null;
  
  if(!isEditingExisting){
    // Don't auto-close on create, let user copy ID
  } else {
    alert('‚úì Portfolio updated!');
    showPage('browsePage');
    renderGallery();
  }
});

document.getElementById('cancelEditBtn').addEventListener('click', ()=>{
  showPage(currentPortfolioId ? 'viewPortfolioPage' : 'browsePage');
});

document.getElementById('addServiceBtn').addEventListener('click', addService);
document.getElementById('addPortfolioBtn').addEventListener('click', addPortfolio);

document.getElementById('copyEmailBtn').addEventListener('click', ()=>{
  const p = allPortfolios.find(x => x.id === currentPortfolioId);
  if(p) navigator.clipboard?.writeText(p.email);
  alert('Email copied!');
});

document.getElementById('copyUserIdBtn').addEventListener('click', ()=>{
  const userId = document.getElementById('displayUserId').textContent;
  navigator.clipboard?.writeText(userId);
  alert('User ID copied to clipboard!');
});

document.getElementById('closeUserIdModal').addEventListener('click', ()=>{
  document.getElementById('userIdModal').classList.remove('active');
  showPage('browsePage');
  renderGallery();
});

document.getElementById('verifyPortfolioBtn').addEventListener('click', ()=>{
  document.getElementById('verificationModal').classList.add('active');
});

document.getElementById('closeVerificationModal').addEventListener('click', ()=>{
  document.getElementById('verificationModal').classList.remove('active');
});

document.getElementById('paypalButton').addEventListener('click', ()=>{
  sessionStorage.setItem('pendingVerificationPortfolioId', currentPortfolioId);
});

window.addEventListener('load', ()=>{
  const params = new URLSearchParams(window.location.search);
  if(params.get('verified') === '1'){
    const portfolioId = sessionStorage.getItem('pendingVerificationPortfolioId');
    if(portfolioId){
      setVerified(portfolioId);
      saveAllPortfolios();
      renderGallery();
      alert('‚úì Portfolio verified! Your profile is now pinned to the top!');
      sessionStorage.removeItem('pendingVerificationPortfolioId');
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  }
});

const verifyBtn = document.getElementById('verifyPortfolioBtn');
if(verifyBtn){
  verifyBtn.addEventListener('click', ()=>{
    sessionStorage.setItem('pendingVerificationPortfolioId', currentPortfolioId);
  });
}

document.getElementById('loadPortfolioBtn')?.addEventListener('click', ()=>{
  const id = document.getElementById('loadPortfolioIdInput').value.trim();
  if(!id){ alert('Enter Portfolio ID'); return; }
  const exists = allPortfolios.find(p => p.id === id);
  if(!exists){ alert('Portfolio not found'); return; }
  viewPortfolio(id);
  document.getElementById('loadPortfolioModal').classList.remove('active');
});

document.getElementById('closeLoadPortfolioModal')?.addEventListener('click', ()=>{
  document.getElementById('loadPortfolioModal').classList.remove('active');
});

/* ============ Admin Functions ============ */
const ADMIN_USERNAME = 'mohamed';

function isAdmin(){
  return currentUsername === ADMIN_USERNAME;
}

function switchAdminTab(tab){
  document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
  event.target?.classList.add('active');
  document.getElementById(tab + 'Tab')?.classList.add('active');
}

function updateAdminStatus(){
  const adminMenu = document.getElementById('adminMenu');
  if(isAdmin()){
    adminMenu.classList.add('show');
  } else {
    adminMenu.classList.remove('show');
  }
}

function refreshSecurityDashboard(){
  // Load security data from localStorage (simulated)
  const securityData = JSON.parse(localStorage.getItem('securityData')) || {
    ipLog: {},
    blockedIPs: [],
    alertLog: []
  };

  // Overview stats
  const stats = document.getElementById('securityStats');
  const totalIPs = Object.keys(securityData.ipLog).length;
  const blockedCount = securityData.blockedIPs.length;
  const recentAlerts = securityData.alertLog.slice(-10).length;

  stats.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
      <div class="security-stat">
        <div class="security-stat-label">Total Tracked IPs</div>
        <div class="security-stat-value">${totalIPs}</div>
      </div>
      <div class="security-stat">
        <div class="security-stat-label">Blocked IPs</div>
        <div class="security-stat-value" style="color:#ef4444">${blockedCount}</div>
      </div>
      <div class="security-stat">
        <div class="security-stat-label">Recent Alerts (24h)</div>
        <div class="security-stat-value">${recentAlerts}</div>
      </div>
      <div class="security-stat">
        <div class="security-stat-label">Total Portfolios</div>
        <div class="security-stat-value">${allPortfolios.length}</div>
      </div>
    </div>
  `;

  // Blocked IPs list
  const blockedList = document.getElementById('blockedIPsList');
  if(securityData.blockedIPs.length > 0){
    blockedList.innerHTML = securityData.blockedIPs.map(ip => `
      <div class="ip-item blocked">
        <div class="ip-item-header">
          <span style="font-family:monospace;font-weight:700">${ip}</span>
          <span class="ip-item-status blocked">üö´ BLOCKED</span>
        </div>
        <div class="muted" style="font-size:0.85rem;margin-top:8px">
          ${securityData.ipLog[ip] ? `Failed logins: ${securityData.ipLog[ip].failedLogins} | Suspicious points: ${securityData.ipLog[ip].suspiciousPoints}` : 'Manually blocked'}
        </div>
      </div>
    `).join('');
  } else {
    blockedList.innerHTML = '<div class="muted" style="padding:20px;text-align:center">No blocked IPs</div>';
  }

  // Alerts list
  const alertsList = document.getElementById('alertsList');
  if(securityData.alertLog.length > 0){
    alertsList.innerHTML = securityData.alertLog.slice(-20).reverse().map(alert => `
      <div class="alert-item">
        <div>
          <div style="font-weight:600;color:var(--accent)">${alert.type}</div>
          <div class="muted" style="font-size:0.9rem">${alert.target}</div>
          <div style="font-size:0.85rem;color:#fbbf24">${alert.reason}</div>
        </div>
        <div class="alert-time">${new Date(alert.timestamp).toLocaleString()}</div>
      </div>
    `).join('');
  } else {
    alertsList.innerHTML = '<div class="muted" style="padding:20px;text-align:center">No alerts</div>';
  }
}

document.getElementById('adminDashboardBtn')?.addEventListener('click', ()=>{
  if(!isAdmin()){ alert('‚ùå Admin access only'); return; }
  document.getElementById('adminDashboard').classList.add('active');
  refreshSecurityDashboard();
});

document.getElementById('closeAdminDashboard')?.addEventListener('click', ()=>{
  document.getElementById('adminDashboard').classList.remove('active');
});

document.getElementById('refreshSecurityBtn')?.addEventListener('click', ()=>{
  refreshSecurityDashboard();
  alert('‚úì Security data refreshed');
});

document.getElementById('blockIPBtn')?.addEventListener('click', ()=>{
  const ip = document.getElementById('blockIPInput').value.trim();
  if(!ip){ alert('Enter IP address'); return; }
  
  let securityData = JSON.parse(localStorage.getItem('securityData')) || {ipLog: {}, blockedIPs: [], alertLog: []};
  if(!securityData.blockedIPs.includes(ip)){
    securityData.blockedIPs.push(ip);
    securityData.alertLog.push({
      timestamp: new Date().toISOString(),
      type: 'ADMIN_BLOCK',
      target: ip,
      reason: 'Manually blocked by admin'
    });
    localStorage.setItem('securityData', JSON.stringify(securityData));
    alert(`‚úì IP ${ip} blocked`);
    document.getElementById('blockIPInput').value = '';
    refreshSecurityDashboard();
  } else {
    alert('IP already blocked');
  }
});

document.getElementById('unblockIPBtn')?.addEventListener('click', ()=>{
  const ip = document.getElementById('unblockIPInput').value.trim();
  if(!ip){ alert('Enter IP address'); return; }
  
  let securityData = JSON.parse(localStorage.getItem('securityData')) || {ipLog: {}, blockedIPs: [], alertLog: []};
  const idx = securityData.blockedIPs.indexOf(ip);
  if (idx > -1) {
    securityData.blockedIPs.splice(idx, 1);
    securityData.alertLog.push({
      timestamp: new Date().toISOString(),
      type: 'ADMIN_UNBLOCK',
      target: ip,
      reason: 'Manually unblocked by admin'
    });
    localStorage.setItem('securityData', JSON.stringify(securityData));
    alert(`‚úì IP ${ip} unblocked`);
    document.getElementById('unblockIPInput').value = '';
    refreshSecurityDashboard();
  } else {
    alert('IP not in blocklist');
  }
});

// Function to log attacker's IP address
async function logAttackerIP(reason) {
  try {
    const response = await fetch('https://api64.ipify.org?format=json');
    const data = await response.json();
    const attackerIP = data.ip;
    console.warn(`Security Alert: ${reason}. Attacker IP: ${attackerIP}`);
    // Optionally, send this data to your server for further analysis
  } catch (error) {
    console.error('Failed to fetch attacker IP:', error);
  }
}

// Function to verify an account
function verifyAccount(userId) {
  if (!userId) {
    logAttackerIP('Attempted verification with invalid user ID');
    alert('Invalid user ID');
    return;
  }

  localStorage.setItem(`verified_${userId}`, 'true');
  alert('Account verified successfully!');
  updateAccountButtons(userId);
}

// Function to unverify an account
function unverifyAccount(userId) {
  if (!userId) {
    logAttackerIP('Attempted unverification with invalid user ID');
    alert('Invalid user ID');
    return;
  }

  localStorage.removeItem(`verified_${userId}`);
  alert('Account unverified successfully!');
  updateAccountButtons(userId);
}

// Admin portfolio verify/unverify buttons (operate on currentPortfolioId)
document.getElementById('verifyBtn')?.addEventListener('click', () => {
  if (!isAdmin()) { alert('‚ùå Admin access only'); return; }
  if (currentPortfolioId) {
    setVerified(currentPortfolioId);
    saveAllPortfolios();
    saveAllPortfolios();
    renderGallery();
    viewPortfolio(currentPortfolioId);
    alert('‚úì Portfolio verified!');
    renderGallery();
    showPage('browsePage');
    alert('‚úì Portfolio verified!');
  }
});

document.getElementById('unverifyBtn')?.addEventListener('click', () => {
  if (!isAdmin()) { alert('‚ùå Admin access only'); return; }
  if (currentPortfolioId) {
    localStorage.removeItem(`portfolioVerified_${currentPortfolioId}`);
    saveAllPortfolios();
    viewPortfolio(currentPortfolioId);
    alert('‚úì Portfolio unverified!');
  }
});

// Function to update the visibility of account Verify/Unverify buttons (if present)
function updateAccountButtons(userId) {
  const isVerifiedAccount = localStorage.getItem(`verified_${userId}`) === 'true';
  const verifyAccountBtnEl = document.getElementById('verifyAccountBtn');
  const unverifyAccountBtnEl = document.getElementById('unverifyAccountBtn');

  if (verifyAccountBtnEl) verifyAccountBtnEl.style.display = isVerifiedAccount ? 'none' : 'block';
  if (unverifyAccountBtnEl) unverifyAccountBtnEl.style.display = isVerifiedAccount ? 'block' : 'none';
}

// Event listeners for account Verify and Unverify buttons (if those elements exist)
const verifyAccountBtn = document.getElementById('verifyAccountBtn');
const unverifyAccountBtn = document.getElementById('unverifyAccountBtn');
const currentUserForAccount = currentUserId || localStorage.getItem('currentUserId');

if (verifyAccountBtn && unverifyAccountBtn && currentUserForAccount) {
  verifyAccountBtn.addEventListener('click', () => verifyAccount(currentUserForAccount));
  unverifyAccountBtn.addEventListener('click', () => unverifyAccount(currentUserForAccount));
  updateAccountButtons(currentUserForAccount);
}

/* ============ Initialize Admin Account ============ */
function initializeAdmin(){
  const adminExists = users[ADMIN_USERNAME];
  if(!adminExists){
    const adminPassword = '@Simovites9';
    users[ADMIN_USERNAME] = {
      password: btoa(adminPassword),
      id: 'admin_' + Date.now(),
      createdAt: new Date().toISOString(),
      fingerprint: clientFingerprint,
      isAdmin: true
    };
    saveUsers();
    console.log('‚úì Admin account created: ' + ADMIN_USERNAME);
  }
}

// Verify no auto-login on page load
function verifyNoAutoLogin(){
  // This function verifies that users are NOT auto-logged in
  if(currentUsername){
    console.log('‚ö†Ô∏è User persisted from localStorage:', currentUsername);
  } else {
    console.log('‚úì Clean login state - no auto-login');
  }
}

updatePortfolioCount();
renderGallery();
initializeAdmin();
updateAdminStatus();
verifyNoAutoLogin();
</script>
</body>
</html>
